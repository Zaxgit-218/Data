<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KCNHS Smart Campus Locator</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --school-blue: #004a99;
            --golden-accent: #f1c40f;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.4);
            --dark-overlay: rgba(0, 20, 40, 0.85);
            --admin-red: #c0392b;
            --admin-green: #27ae60;
            --admin-purple: #8e44ad;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; height: 100dvh;
            font-family: 'Inter', sans-serif; overflow: hidden;
            background: #f0f2f5; -webkit-tap-highlight-color: transparent;
        }

        #map {
            width: 100%; height: 100%; background: #f3f3f3;
            filter: blur(4px); transition: filter 0.8s ease; z-index: 1;
        }
        #map.active { filter: blur(0px); }

        /* Standby Screen */
        #standby-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            background: var(--dark-overlay); display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center;
            transition: opacity 0.5s ease, visibility 0.5s; cursor: pointer; padding: 20px; box-sizing: border-box;
        }
        #standby-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .standby-content h2 { font-size: 48px; margin: 0; font-weight: 700; }
        .standby-content h3 { font-size: 32px; color: var(--golden-accent); margin: 10px 0 40px 0; font-weight: 300; font-style: italic; }
        .pulse-btn {
            font-size: 18px; text-transform: uppercase; letter-spacing: 2px;
            background: rgba(255, 255, 255, 0.1); padding: 15px 40px;
            border-radius: 50px; border: 1px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; border-color: var(--golden-accent); }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* UI Containers */
        .overlay-container {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            width: 360px; pointer-events: none; opacity: 0;
            transform: translateX(-50px); transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .overlay-container.visible { opacity: 1; transform: translateX(0); pointer-events: auto; }
        .overlay-container.force-hidden { opacity: 0 !important; pointer-events: none !important; }

        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .school-logo {
            width: 54px; height: 54px; background: var(--school-blue); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white;
            font-weight: bold; font-size: 12px; border: 2px solid var(--golden-accent);
            cursor: pointer; user-select: none; transition: transform 0.2s; flex-shrink: 0;
        }
        .school-logo:active { transform: scale(0.9); }
        .title-group h1 { font-size: 18px; margin: 0; color: var(--school-blue); font-weight: 700; }
        .title-group p { font-size: 12px; margin: 0; color: #666; }

        input, select, textarea {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1);
            font-size: 16px; box-sizing: border-box; outline: none; margin-bottom: 8px;
            font-family: inherit; background: white; -webkit-appearance: none;
        }

        .instruction-text { font-size: 13px; color: #444; line-height: 1.4; padding: 8px 0; border-top: 1px solid rgba(0,0,0,0.05); }
        .building-description {
            margin-top: 10px; padding: 12px; background: rgba(0, 74, 153, 0.08);
            border-left: 4px solid var(--school-blue); border-radius: 0 8px 8px 0;
            font-size: 13px; color: #222; display: none; animation: slideDown 0.3s ease-out;
        }
        .btn-navigate {
            width: 100%; padding: 16px; background: var(--school-blue); color: white;
            border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 15px;
            transition: all 0.2s; touch-action: manipulation;
        }
        .btn-navigate:active { transform: scale(0.98); }

        #dest-photo-island {
            position: absolute; left: 20px; bottom: 20px; z-index: 1000; width: 320px;
            max-width: calc(100vw - 40px); opacity: 0; visibility: hidden;
            transform: translateY(20px); transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s;
            pointer-events: auto;
        }
        #dest-photo-island.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        #dest-photo-island.force-hidden { opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; }
        #dest-photo-island .glass-panel { margin-bottom: 0; padding: 15px; }
        #dest-photo-island .dest-photo-title { font-size: 16px; font-weight: 700; color: var(--school-blue); margin-bottom: 8px; }
        #dest-photo-island #dest-photo-img { width: 100%; border-radius: 12px; display: block; box-shadow: 0 4px 14px rgba(0,0,0,0.2); }
        #dest-photo-island .dest-photo-desc { font-size: 13px; color: #444; margin-top: 10px; line-height: 1.4; }

        /* --- Admin Panel (Desktop Default) --- */
        #admin-panel {
            position: absolute; top: 20px; right: 20px; z-index: 3000; width: 380px; display: none;
            max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch; 
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); /* Smooth spring-like transition */
        }
        #admin-panel.visible { display: block; }
        
        /* Desktop Minimized State (Bubble) */
        #admin-panel.minimized {
            width: 50px; height: 50px; overflow: hidden; padding: 0; border-radius: 50%;
            top: 20px; right: 20px; bottom: auto; left: auto; cursor: pointer;
            display: flex; align-items: center; justify-content: center; background: var(--admin-red);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #admin-panel.minimized .admin-content-wrapper { display: none; }
        #admin-panel.minimized::after { content: "‚öôÔ∏è"; font-size: 24px; }
        
        .admin-header {
            color: var(--admin-red); font-weight: 800; font-size: 16px; margin-bottom: 15px;
            display: flex; justify-content: space-between; position: sticky; top: 0; background: inherit; padding-top: 5px;
            align-items: center;
        }
        .admin-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; }
        .admin-label { font-size: 11px; font-weight: 800; text-transform: uppercase; color: #555; margin-bottom: 6px; display: block; }
        .coord-pill { background: #1a1a1a; color: #00ff00; padding: 10px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 14px; margin-bottom: 12px; display: block; text-align: center; border: 1px solid #333; }
        .admin-btn {
            width: 100%; padding: 14px; background: #555; color: white; border: none; border-radius: 10px;
            cursor: pointer; font-size: 13px; transition: background 0.2s; margin-top: 5px;
        }
        .admin-btn.save { background: var(--school-blue); font-weight: bold; }
        .admin-btn.update { background: var(--admin-green); font-weight: bold; }
        .admin-btn.mode { background: var(--admin-purple); font-weight: bold; }
        .admin-btn.download { background: #e67e22; font-weight: bold; }
        .location-list { margin-top: 10px; background: white; border-radius: 12px; max-height: 180px; overflow-y: auto; border: 1px solid #eee; }
        .location-item { padding: 12px 15px; border-bottom: 1px solid #f5f5f5; font-size: 13px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .admin-node-handle { background: white; border: 2px solid var(--admin-purple); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: var(--admin-purple); }
        .path-animation { stroke-dasharray: 12, 12; animation: dash 0.8s linear infinite; }
        @keyframes dash { from { stroke-dashoffset: 24; } to { stroke-dashoffset: 0; } }
        
        /* Kiosk Icon */
        .kiosk-icon { background: transparent; }
        .kiosk-icon-inner { width: 24px; height: 24px; border-radius: 50%; background: var(--school-blue); border: 4px solid #fff; box-shadow: 0 0 15px rgba(0,0,0,0.6); position: relative; }
        .kiosk-icon-inner::after { content: ""; position: absolute; left: 50%; top: 50%; width: 24px; height: 24px; margin-left: -12px; margin-top: -12px; border-radius: 50%; border: 2px solid var(--golden-accent); animation: kioskPulse 1.8s ease-out infinite; }
        @keyframes kioskPulse { 0% { transform: scale(0.9); opacity: 0.8; } 70% { transform: scale(1.4); opacity: 0; } 100% { transform: scale(1.4); opacity: 0; } }

        #admin-pin-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.65); display: flex; align-items: center; justify-content: center; z-index: 3500; opacity: 0; visibility: hidden; transition: opacity 0.25s ease, visibility 0.25s ease; }
        #admin-pin-overlay.visible { opacity: 1; visibility: visible; }
        .pin-card { width: 320px; max-width: 90vw; background: var(--glass-bg); border-radius: 16px; padding: 20px 20px 16px; box-shadow: 0 18px 45px rgba(0,0,0,0.4); border: 1px solid var(--glass-border); }
        .pin-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.12); font-size: 20px; letter-spacing: 4px; text-align: center; }
        .pin-actions { margin-top: 16px; display: flex; justify-content: flex-end; gap: 8px; }
        .pin-actions button { border-radius: 999px; border: none; padding: 10px 20px; font-size: 14px; cursor: pointer; }
        .pin-btn-cancel { background: #ececec; color: #555; }
        .pin-btn-confirm { background: var(--school-blue); color: #fff; }
        .file-upload-label { display: flex; align-items: center; justify-content: center; padding: 12px; border-radius: 12px; background: var(--school-blue); color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; margin: 4px 0 8px 0; }

        /* --- MOBILE SPECIFIC STYLES --- */
        @media (max-width: 768px) {
            .standby-content h2 { font-size: 28px; }
            .standby-content h3 { font-size: 18px; margin-bottom: 25px; }
            .pulse-btn { padding: 12px 30px; font-size: 14px; }

            /* Top Search Bar: Compact */
            .overlay-container { width: 94%; left: 3%; top: 10px; transform: none; }
            .glass-panel { padding: 15px; border-radius: 16px; }
            .search-box input { padding: 10px 12px; font-size: 14px; height: 44px; margin-bottom: 5px; }
            .btn-navigate { padding: 12px; font-size: 14px; height: 44px; margin-top: 5px; }
            .header { margin-bottom: 10px; }
            .school-logo { width: 40px; height: 40px; font-size: 10px; }
            .title-group h1 { font-size: 16px; }

            /* Photo Result: Bottom Sheet */
            #dest-photo-island { width: 100%; left: 0; bottom: 0; transform: translateY(110%); }
            #dest-photo-island.visible { transform: translateY(0); }
            #dest-photo-island .glass-panel { border-radius: 20px 20px 0 0; border-bottom: none; padding: 20px; }

            /* --- ADMIN MOBILE: COLLAPSIBLE BOTTOM SHEET --- */
            #admin-panel { 
                width: 100%; 
                height: 55vh; /* Opened height */
                max-height: 55vh;
                top: auto; bottom: 0; right: 0; left: 0;
                border-radius: 20px 20px 0 0; 
                border: none;
                padding-bottom: 20px;
                background: #fff;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            }

            /* Minimized = Collapsed to Bottom Bar */
            #admin-panel.minimized { 
                width: 100%; 
                height: 60px; /* Collapsed height (Header only) */
                border-radius: 20px 20px 0 0;
                top: auto; bottom: 0; right: 0; left: 0;
                background: #fff;
                box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
                padding: 0;
                overflow: hidden;
                display: block; /* Override flex */
            }

            /* When minimized on mobile, show the header inside the bar */
            #admin-panel.minimized .admin-content-wrapper { display: block; }
            #admin-panel.minimized .admin-section { display: none; } /* Hide content */
            #admin-panel.minimized .admin-header {
                height: 100%;
                border-bottom: none;
                padding: 0 20px;
                margin: 0;
            }
            #admin-panel.minimized::after { content: none; } /* Remove bubble icon */

            /* Admin Header in Drawer */
            .admin-header { 
                position: sticky; top: 0; background: #fff; z-index: 10; 
                padding-bottom: 10px; border-bottom: 1px solid #eee; 
            }
            .admin-btn { padding: 12px; margin-top: 8px; font-size: 14px; }
            .location-item { padding: 15px 10px; }
        }
    </style>
</head>
<body>

    <div id="standby-screen" onclick="exitStandby()">
        <div class="standby-content">
            <h2>Looking for something?</h2>
            <h3>Tap anywhere to start</h3>
            <div class="pulse-btn">Tap to Begin</div>
        </div>
    </div>

    <div id="admin-pin-overlay" onclick="maybeClosePinOverlay(event)">
        <div class="pin-card" onclick="event.stopPropagation()">
            <h3 style="margin-top:0; color:var(--school-blue);">Admin Access</h3>
            <p style="color:#666; font-size:13px; margin-bottom:10px;">Enter 4-digit PIN</p>
            <input type="password" id="admin-pin-input" class="pin-input" maxlength="6" inputmode="numeric" autocomplete="off">
            <div id="admin-pin-error" style="color:#c0392b; font-size:12px; min-height:18px; margin-top:5px;"></div>
            <div class="pin-actions">
                <button class="pin-btn-cancel" onclick="hideAdminPinOverlay()">Cancel</button>
                <button class="pin-btn-confirm" onclick="submitAdminPin()">Unlock</button>
            </div>
        </div>
    </div>

    <div id="status-bar" style="position:fixed; left:50%; bottom:30px; transform:translateX(-50%); width:80%; max-width:300px; padding:12px 16px; border-radius:50px; font-size:13px; font-weight:600; text-align:center; color:#fff; background:rgba(0,0,0,0.8); z-index:4000; opacity:0; pointer-events:none; transition:opacity 0.3s ease, transform 0.3s ease;"></div>

    <div class="overlay-container" id="main-ui">
        <div class="glass-panel">
            <div class="header">
                <div class="school-logo" id="logo-trigger">KCNHS</div>
                <div class="title-group">
                    <h1>Campus Locator</h1>
                    <p>Find your way around</p>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="dest-input" list="locations" placeholder="Search building or room..." autocomplete="off">
                <datalist id="locations"></datalist>
                <div class="instruction-text" id="instruction-text">Choose a destination below.</div>
                <button class="btn-navigate" onclick="startNavigation()">Start Navigation</button>
                <div id="building-desc-box" class="building-description"></div>
            </div>
            <div style="text-align: center; margin-top: 5px;">
                <button onclick="enterStandby()" style="background:none; border:none; color:var(--school-blue); text-decoration:underline; font-size:12px; padding:10px; cursor:pointer; opacity: 0.7;">Reset Map</button>
            </div>
        </div>
    </div>

    <div id="dest-photo-island">
        <div class="glass-panel">
            <div id="dest-photo-title" class="dest-photo-title"></div>
            <img id="dest-photo-img" alt="" style="display:none;">
            <div id="dest-photo-desc" class="dest-photo-desc" style="display:none;"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="glass-panel" onclick="if(this.classList.contains('minimized')) toggleAdminMinimize()">
        <div class="admin-content-wrapper">
            <div class="admin-header">
                <span onclick="toggleAdminMinimize()" style="flex-grow:1;">ADMIN MODE</span>
                <div style="display:flex; align-items:center;">
                    <!-- Mobile Collapse Toggle -->
                    <button id="min-btn" onclick="toggleAdminMinimize()" title="Minimize" style="border:none; background:none; cursor:pointer; font-size: 18px; padding:8px; color:#555; background:#f0f0f0; border-radius:8px; margin-right:8px;">
                        ‚ñº
                    </button>
                    <button onclick="closeAdmin()" title="Close" style="border:none; background:none; cursor:pointer; font-size: 24px; padding:0 5px; color:#555; line-height:1;">‚úï</button>
                </div>
            </div>
            
            <div class="admin-section" style="margin-top:0; border:none; padding-top:0;">
                <span class="admin-label">View Options</span>
                <button class="admin-btn" style="background:#7f8c8d; margin-top:0;" onclick="toggleUserUI()">üëÅ Toggle User UI</button>
            </div>

            <div class="admin-section">
                <span class="admin-label">Map Tap Coordinate</span>
                <span id="coord-display" class="coord-pill">[Tap Map]</span>
                <button class="admin-btn mode" id="path-mode-btn" onclick="togglePathMode()">Path Builder: OFF</button>
                <button class="admin-btn undo" id="path-undo-btn" onclick="undoLastJunction()" style="display:none; background:#e67e22;">Undo Last Junction</button>
            </div>

            <div class="admin-section">
                <span class="admin-label">Quick Edit</span>
                <div class="location-list" id="admin-manage-list"></div>
            </div>

            <div class="admin-section" id="admin-form-container">
                <span class="admin-label" id="form-title">Add / Edit Location</span>
                <input type="text" id="admin-dest-name" placeholder="Name (e.g. Canteen)">
                <textarea id="admin-dest-desc" placeholder="Details (e.g. Near Gate 1)" rows="2"></textarea>
                <span class="admin-label">Photo</span>
                <label class="file-upload-label">
                    <span>Upload Image</span>
                    <input type="file" id="admin-dest-image" accept="image/*" style="display:none;">
                </label>
                <div id="admin-image-preview-container" style="display:none; margin:6px 0 10px 0;">
                    <img id="admin-image-preview" src="" alt="Preview" style="max-width:100%; border-radius:10px;">
                </div>
                <input type="text" id="admin-dest-path" placeholder="Path Sequence (e.g. j1, j2)">
                <div id="admin-action-btns">
                    <button class="admin-btn save" onclick="adminAddDest()">Add Location</button>
                </div>
                <button class="admin-btn" style="background:#eee; color:#333;" onclick="resetAdminForm()">Clear Form</button>
            </div>

            <div class="admin-section" style="border:none; padding-bottom:40px;">
                <button class="admin-btn download" onclick="downloadJSON()">Download JSON Database</button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIG ---
        const ADMIN_PIN = '1234';
        const MAP_IMAGE = 'Map.png';

        // --- DATA STORE ---
        let campusData = { kiosk: [500, 500], nodes: {}, destinations: {} };
        let map, currentPathLayer, destMarkerLayer, adminMarker;
        let lastClickedCoord = [0, 0];
        let editingKey = null;
        let idleTimer, statusTimeoutId;
        let pathMode = false;
        let tempPathNodes = []; 
        let tempPathPolyline = null;
        let currentEditingImageUrl = "";
        let userUIHidden = false;

        window.onload = function() {
            initMap();
            loadCampusData();
            setupEventListeners();
        };

        function initMap() {
            map = L.map('map', {
                crs: L.CRS.Simple, minZoom: -2, maxZoom: 2, zoomControl: false, tap: false
            });
            const bounds = [[0, 0], [1000, 1500]];
            L.imageOverlay(MAP_IMAGE, bounds).addTo(map);
            map.fitBounds(bounds);
            map.on('click', onMapClick);
        }

        async function loadCampusData() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error("No data");
                const data = await response.json();
                if (data.nodes) campusData.nodes = data.nodes;
                if (data.destinations) campusData.destinations = data.destinations;
                if (data.kiosk) campusData.kiosk = data.kiosk;
                placeKioskMarker();
                refreshLists();
            } catch (err) {
                console.log('Using new/empty database.');
                placeKioskMarker();
            }
        }

        function placeKioskMarker() {
            const kioskIcon = L.divIcon({
                className: 'kiosk-icon',
                html: `<div class="kiosk-icon-inner"></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            L.marker(campusData.kiosk, { icon: kioskIcon }).addTo(map).bindPopup("<b>You are here</b>");
        }

        function downloadJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(campusData, null, 2));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", "data.json");
            document.body.appendChild(dlNode);
            dlNode.click();
            dlNode.remove();
            showStatus("Downloaded! Upload to GitHub.", "success");
        }

        document.getElementById('admin-dest-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2.5 * 1024 * 1024) { alert("Image too big (Max 2.5MB)"); this.value = ""; return; }
            const reader = new FileReader();
            reader.onload = function(event) {
                currentEditingImageUrl = event.target.result;
                const preview = document.getElementById('admin-image-preview');
                const container = document.getElementById('admin-image-preview-container');
                preview.src = currentEditingImageUrl;
                container.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        function refreshLists() {
            const datalist = document.getElementById('locations');
            const manageList = document.getElementById('admin-manage-list');
            datalist.innerHTML = ""; manageList.innerHTML = "";
            Object.keys(campusData.destinations).sort().forEach(name => {
                let opt = document.createElement('option');
                opt.value = name;
                datalist.appendChild(opt);
                let item = document.createElement('div');
                item.className = 'location-item';
                item.innerHTML = `<span><b>${name}</b></span> <span style="color:var(--school-blue);">Edit</span>`;
                item.onclick = (e) => { e.stopPropagation(); loadForEdit(name); };
                manageList.appendChild(item);
            });
        }

        function startNavigation() {
            const rawName = document.getElementById('dest-input').value.trim();
            const destKey = Object.keys(campusData.destinations).find(k => k.toLowerCase() === rawName.toLowerCase());
            const dest = destKey ? campusData.destinations[destKey] : null;
            if (!dest) { showStatus("Location not found", "error"); return; }
            document.getElementById('dest-input').blur();
            if (currentPathLayer) map.removeLayer(currentPathLayer);
            if (destMarkerLayer) map.removeLayer(destMarkerLayer);
            const junctionCoords = (dest.path || []).map(id => campusData.nodes[id]).filter(Boolean);
            const fullRoute = [campusData.kiosk, ...junctionCoords, dest.coords];
            currentPathLayer = L.polyline(fullRoute, { color: 'var(--golden-accent)', weight: 6, opacity: 0.9, dashArray: '12, 12', className: 'path-animation' }).addTo(map);
            destMarkerLayer = L.marker(dest.coords).addTo(map).bindPopup(`<b>${destKey}</b>`).openPopup();
            const routeBounds = L.latLngBounds(fullRoute);
            map.fitBounds(routeBounds, { padding: [50, 50] });
            const photoIsland = document.getElementById('dest-photo-island');
            const photoImg = document.getElementById('dest-photo-img');
            const descBox = document.getElementById('building-desc-box');
            if (dest.imageUrl) {
                document.getElementById('dest-photo-title').textContent = destKey;
                photoImg.src = dest.imageUrl; photoImg.style.display = 'block';
                document.getElementById('dest-photo-desc').textContent = dest.description;
                document.getElementById('dest-photo-desc').style.display = dest.description ? 'block' : 'none';
                if(!userUIHidden) photoIsland.classList.add('visible');
                descBox.style.display = 'none';
            } else {
                photoIsland.classList.remove('visible');
                descBox.innerHTML = dest.description ? `<strong>Info:</strong><br>${dest.description}` : "";
                descBox.style.display = dest.description ? 'block' : 'none';
            }
        }

        function adminAddDest(isUpdate = false) {
            const name = document.getElementById('admin-dest-name').value;
            const desc = document.getElementById('admin-dest-desc').value;
            const pathInput = document.getElementById('admin-dest-path').value;
            if (!name) return alert("Enter Name");
            if (isUpdate && editingKey && editingKey !== name) delete campusData.destinations[editingKey];
            campusData.destinations[name] = {
                coords: [...lastClickedCoord], description: desc,
                imageUrl: currentEditingImageUrl || "",
                path: pathInput ? pathInput.split(',').map(s => s.trim()).filter(Boolean) : []
            };
            refreshLists(); resetAdminForm();
            if (pathMode) togglePathMode();
            showStatus(isUpdate ? "Updated!" : "Added!", "success");
        }

        function loadForEdit(name) {
            editingKey = name;
            const dest = campusData.destinations[name];
            document.getElementById('form-title').innerText = "Edit: " + name;
            document.getElementById('admin-dest-name').value = name;
            document.getElementById('admin-dest-desc').value = dest.description || "";
            document.getElementById('admin-dest-path').value = dest.path.join(', ');
            currentEditingImageUrl = dest.imageUrl || "";
            const preview = document.getElementById('admin-image-preview');
            const container = document.getElementById('admin-image-preview-container');
            if(currentEditingImageUrl) { preview.src = currentEditingImageUrl; container.style.display = 'block'; } else { container.style.display = 'none'; }
            lastClickedCoord = [...dest.coords];
            document.getElementById('coord-display').innerText = `[${Math.round(lastClickedCoord[0])}, ${Math.round(lastClickedCoord[1])}]`;
            document.getElementById('admin-action-btns').innerHTML = `<button class="admin-btn update" onclick="adminAddDest(true)">Update</button><button class="admin-btn" style="background:#c0392b; margin-top:5px;" onclick="deleteLocation('${name}')">Delete</button>`;
            map.setView(dest.coords, 0);
            if (adminMarker) map.removeLayer(adminMarker);
            adminMarker = L.circleMarker(dest.coords, { radius: 10, color: 'red' }).addTo(map);
            if(window.innerWidth < 768) {
                // On mobile, don't auto scroll, user can see map first
            } else {
                document.getElementById('admin-form-container').scrollIntoView({behavior: "smooth"});
            }
        }

        function deleteLocation(name) {
            if (confirm(`Delete ${name}?`)) { delete campusData.destinations[name]; refreshLists(); resetAdminForm(); showStatus("Deleted", "error"); }
        }

        function resetAdminForm() {
            editingKey = null;
            document.getElementById('form-title').innerText = "Add New";
            document.getElementById('admin-dest-name').value = "";
            document.getElementById('admin-dest-desc').value = "";
            document.getElementById('admin-dest-image').value = "";
            document.getElementById('admin-image-preview-container').style.display = 'none';
            currentEditingImageUrl = "";
            document.getElementById('admin-dest-path').value = "";
            document.getElementById('admin-action-btns').innerHTML = `<button class="admin-btn save" onclick="adminAddDest()">Add Location</button>`;
            if (adminMarker) map.removeLayer(adminMarker);
        }

        function onMapClick(e) {
            lastClickedCoord = [e.latlng.lat, e.latlng.lng];
            resetIdleTimer();
            if (document.getElementById('admin-panel').classList.contains('visible')) {
                if (pathMode) { addJunctionToPath(e.latlng); }
                else {
                    document.getElementById('coord-display').innerText = `[${Math.round(e.latlng.lat)}, ${Math.round(e.latlng.lng)}]`;
                    if (adminMarker) map.removeLayer(adminMarker);
                    adminMarker = L.circleMarker(e.latlng, { radius: 10, color: 'red' }).addTo(map);
                }
            }
        }

        function togglePathMode() {
            pathMode = !pathMode;
            const btn = document.getElementById('path-mode-btn');
            const undoBtn = document.getElementById('path-undo-btn');
            if (pathMode) {
                btn.innerText = "Path Builder: ON"; btn.style.background = "#c0392b"; undoBtn.style.display = "block";
                tempPathNodes = []; if (tempPathPolyline) map.removeLayer(tempPathPolyline);
                tempPathPolyline = L.polyline([], {color: 'var(--admin-purple)', weight: 3, dashArray: '5,5'}).addTo(map);
            } else {
                btn.innerText = "Path Builder: OFF"; btn.style.background = "var(--admin-purple)"; undoBtn.style.display = "none";
                tempPathNodes.forEach(node => map.removeLayer(node.marker));
                if (tempPathPolyline) map.removeLayer(tempPathPolyline);
            }
        }

        function addJunctionToPath(latlng) {
            const nodeId = 'j' + (Object.keys(campusData.nodes).length + 1);
            const marker = L.marker(latlng, { icon: L.divIcon({ className: 'admin-node-handle', html: tempPathNodes.length + 1, iconSize: [24, 24] }), draggable: true }).addTo(map);
            campusData.nodes[nodeId] = [latlng.lat, latlng.lng];
            tempPathNodes.push({ id: nodeId, marker: marker });
            marker.on('drag', updatePathLine);
            marker.on('dragend', () => { campusData.nodes[nodeId] = [marker.getLatLng().lat, marker.getLatLng().lng]; });
            updatePathLine();
        }

        function updatePathLine() {
            if (!tempPathPolyline) return;
            tempPathPolyline.setLatLngs(tempPathNodes.map(n => n.marker.getLatLng()));
            document.getElementById('admin-dest-path').value = tempPathNodes.map(n => n.id).join(', ');
        }

        function undoLastJunction() {
            if (tempPathNodes.length === 0) return;
            const last = tempPathNodes.pop(); map.removeLayer(last.marker); delete campusData.nodes[last.id]; updatePathLine();
        }

        // --- NEW FEATURES: UI TOGGLES ---
        function toggleUserUI() {
            userUIHidden = !userUIHidden;
            const mainUI = document.getElementById('main-ui');
            const photoUI = document.getElementById('dest-photo-island');
            
            if (userUIHidden) {
                mainUI.classList.add('force-hidden');
                photoUI.classList.add('force-hidden');
            } else {
                mainUI.classList.remove('force-hidden');
                photoUI.classList.remove('force-hidden');
            }
        }

        function toggleAdminMinimize() {
            const panel = document.getElementById('admin-panel');
            const btn = document.getElementById('min-btn');
            panel.classList.toggle('minimized');
            
            // Update icon
            if(panel.classList.contains('minimized')) {
                btn.innerText = '‚ñ≤'; 
            } else {
                btn.innerText = '‚ñº';
            }
        }

        function enterStandby() {
            document.getElementById('standby-screen').classList.remove('hidden');
            document.getElementById('map').classList.remove('active');
            document.getElementById('main-ui').classList.remove('visible');
            document.getElementById('dest-photo-island').classList.remove('visible');
            if (currentPathLayer) map.removeLayer(currentPathLayer);
            if (destMarkerLayer) map.removeLayer(destMarkerLayer);
            document.getElementById('dest-input').value = "";
            map.fitBounds([[0, 0], [1000, 1500]]);
        }
        function exitStandby() {
            document.getElementById('standby-screen').classList.add('hidden');
            document.getElementById('map').classList.add('active');
            document.getElementById('main-ui').classList.add('visible');
            resetIdleTimer();
        }
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            if (!document.getElementById('admin-panel').classList.contains('visible')) {
                idleTimer = setTimeout(enterStandby, 120000); 
            }
        }
        function setupEventListeners() {
            const logo = document.getElementById('logo-trigger');
            let timer;
            const startPress = (e) => { timer = setTimeout(showAdminPinOverlay, 3000); };
            const endPress = (e) => { clearTimeout(timer); };
            logo.addEventListener('mousedown', startPress);
            logo.addEventListener('touchstart', (e) => { startPress(e); });
            logo.addEventListener('mouseup', endPress);
            logo.addEventListener('mouseleave', endPress);
            logo.addEventListener('touchend', endPress);
            window.addEventListener('click', resetIdleTimer);
            window.addEventListener('touchstart', resetIdleTimer);
        }

        function showStatus(msg, type) {
            const bar = document.getElementById('status-bar');
            bar.textContent = msg;
            bar.style.background = type === 'success' ? '#27ae60' : type === 'error' ? '#c0392b' : '#004a99';
            bar.style.opacity = '1'; bar.style.transform = 'translateX(-50%) translateY(0)';
            clearTimeout(statusTimeoutId);
            statusTimeoutId = setTimeout(() => { bar.style.opacity = '0'; bar.style.transform = 'translateX(-50%) translateY(20px)'; }, 3000);
        }

        function showAdminPinOverlay() { document.getElementById('admin-pin-overlay').classList.add('visible'); }
        function hideAdminPinOverlay() { document.getElementById('admin-pin-overlay').classList.remove('visible'); }
        function maybeClosePinOverlay() { hideAdminPinOverlay(); }
        function submitAdminPin() {
            const val = document.getElementById('admin-pin-input').value;
            if(val === ADMIN_PIN) {
                hideAdminPinOverlay();
                document.getElementById('admin-panel').classList.add('visible');
                showStatus("Admin Unlocked", "success");
            } else { document.getElementById('admin-pin-error').textContent = "Incorrect PIN"; }
        }
        function closeAdmin() { 
            const panel = document.getElementById('admin-panel');
            panel.classList.remove('visible'); 
            panel.classList.remove('minimized');
            document.getElementById('min-btn').innerText = '‚ñº';
            if(userUIHidden) toggleUserUI(); 
            if(pathMode) togglePathMode();
        }
    </script>
</body>
</html>
